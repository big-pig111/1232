<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Meme Token Launcher - LetsBonk + Phantom</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // 全局变量
    let walletAdapter = null;
    let isConnected = false;
    let debugMode = true; // 开启调试模式

    // 调试日志函数
    function debugLog(message, data = null) {
      if (debugMode) {
        console.log(`[Wallet Debug] ${message}`, data || '');
      }
    }

    // 检查 Phantom 钱包是否安装
    function isPhantomInstalled() {
      const hasWindow = typeof window !== 'undefined';
      const hasSolana = hasWindow && typeof window.solana !== 'undefined';
      const isPhantom = hasSolana && window.solana.isPhantom;
      
      debugLog('Phantom 检查结果:', {
        hasWindow,
        hasSolana,
        isPhantom,
        solanaObject: window.solana
      });
      
      return isPhantom;
    }

    // 更新钱包UI状态
    function updateWalletUI() {
      debugLog('更新UI状态', { isConnected, hasAdapter: !!walletAdapter });
      
      const connectBtn = document.getElementById("connectBtn");
      const walletAddress = document.getElementById("walletAddress");
      const mintBtn = document.querySelector("button[onclick='createToken()']");

      if (!connectBtn || !walletAddress || !mintBtn) {
        debugLog('UI元素未找到', { connectBtn: !!connectBtn, walletAddress: !!walletAddress, mintBtn: !!mintBtn });
        return;
      }

      if (isConnected && walletAdapter && walletAdapter.publicKey) {
        const address = walletAdapter.publicKey.toBase58();
        const shortAddress = `${address.slice(0, 4)}...${address.slice(-4)}`;
        
        connectBtn.innerHTML = "🔗 断开钱包";
        connectBtn.className = "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700";
        connectBtn.onclick = disconnectWallet;
        
        walletAddress.innerHTML = `🟢 已连接: <span class="font-mono">${shortAddress}</span>`;
        walletAddress.className = "mt-2 text-sm text-green-600 font-medium";
        
        mintBtn.disabled = false;
        mintBtn.className = "mt-6 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 font-semibold";
      } else {
        connectBtn.innerHTML = "🔌 连接 Phantom";
        connectBtn.className = "bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700";
        connectBtn.onclick = connectWallet;
        
        walletAddress.innerHTML = "🔴 未连接钱包";
        walletAddress.className = "mt-2 text-sm text-red-600";
        
        mintBtn.disabled = true;
        mintBtn.className = "mt-6 w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed font-semibold";
      }
    }

    // 连接钱包 - 简化版本
    async function connectWallet() {
      debugLog('开始连接钱包...');
      
      const connectBtn = document.getElementById("connectBtn");
      const walletAddress = document.getElementById("walletAddress");

      try {
        // 显示连接中状态
        if (connectBtn) {
          connectBtn.innerHTML = "⏳ 连接中...";
          connectBtn.disabled = true;
        }
        if (walletAddress) {
          walletAddress.innerHTML = "🔄 正在连接钱包...";
          walletAddress.className = "mt-2 text-sm text-yellow-600";
        }

        // 检查是否安装了 Phantom
        if (!isPhantomInstalled()) {
          debugLog('Phantom 未安装');
          if (walletAddress) {
            walletAddress.innerHTML = "❌ 请先安装 <a href='https://phantom.app/' target='_blank' class='text-blue-600 underline'>Phantom 钱包</a>";
            walletAddress.className = "mt-2 text-sm text-red-600";
          }
          showNotification("请先安装 Phantom 钱包", "error");
          return;
        }

        debugLog('尝试直接使用 window.solana 连接...');
        
        // 直接使用 window.solana 而不是适配器
        const provider = window.solana;
        
        if (!provider) {
          throw new Error('Phantom 钱包未找到');
        }

        // 连接钱包
        const response = await provider.connect();
        debugLog('连接响应:', response);
        
        isConnected = true;
        walletAdapter = {
          publicKey: response.publicKey || provider.publicKey,
          disconnect: () => provider.disconnect()
        };
        window.wallet = walletAdapter;
        
        // 监听钱包断开事件
        provider.on('disconnect', () => {
          debugLog('钱包断开事件触发');
          isConnected = false;
          window.wallet = null;
          walletAdapter = null;
          updateWalletUI();
        });

        updateWalletUI();
        showNotification("钱包连接成功！", "success");
        debugLog('钱包连接成功');

      } catch (error) {
        debugLog('钱包连接失败:', error);
        isConnected = false;
        
        let errorMessage = "连接失败";
        if (error.message && error.message.includes('User rejected')) {
          errorMessage = "用户取消连接";
        } else if (error.code === 4001) {
          errorMessage = "用户拒绝连接";
        }
        
        if (walletAddress) {
          walletAddress.innerHTML = `❌ ${errorMessage}`;
          walletAddress.className = "mt-2 text-sm text-red-600";
        }
        
        updateWalletUI();
        showNotification(errorMessage, "error");
      } finally {
        if (connectBtn) {
          connectBtn.disabled = false;
        }
      }
    }

    // 断开钱包
    async function disconnectWallet() {
      debugLog('断开钱包...');
      try {
        if (window.solana && window.solana.disconnect) {
          await window.solana.disconnect();
        }
        isConnected = false;
        window.wallet = null;
        walletAdapter = null;
        updateWalletUI();
        showNotification("钱包已断开", "info");
        debugLog('钱包断开成功');
      } catch (error) {
        debugLog('断开钱包失败:', error);
        showNotification("断开钱包失败", "error");
      }
    }

    // 显示通知
    function showNotification(message, type = "info") {
      debugLog('显示通知:', { message, type });
      
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : 
                     type === 'error' ? 'bg-red-500' : 
                     type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
      
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // 显示动画
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);
      
      // 3秒后移除
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // 测试按钮点击
    function testClick() {
      debugLog('测试按钮被点击');
      alert('按钮点击正常工作!');
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('页面DOM加载完成');
      
      // 等待一段时间再初始化，确保所有资源都加载完成
      setTimeout(() => {
        debugLog('开始初始化钱包UI...');
        updateWalletUI();
        
        // 检查钱包状态
        if (isPhantomInstalled() && window.solana.isConnected) {
          debugLog('检测到钱包已连接，尝试重连...');
          connectWallet();
        }
        
        debugLog('初始化完成');
      }, 500);
    });

    // 暴露函数到全局作用域
    window.connectWallet = connectWallet;
    window.disconnectWallet = disconnectWallet;
    window.updateWalletUI = updateWalletUI;
    window.testClick = testClick;
    window.debugLog = debugLog;
  </script>
</head>
<body class="bg-gradient-to-r from-purple-100 via-yellow-100 to-blue-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">🚀 Launch Meme Token</h1>

    <!-- 调试信息 -->
    <div class="mb-4 p-2 bg-gray-100 rounded text-xs">
      <div>调试模式: <span id="debugStatus">开启</span></div>
      <div>钱包状态: <span id="walletStatus">未检查</span></div>
      <button onclick="testClick()" class="mt-1 px-2 py-1 bg-blue-500 text-white rounded text-xs">测试点击</button>
    </div>

    <!-- Wallet -->
    <div class="mb-6 text-center">
      <button id="connectBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
        🔌 连接 Phantom
      </button>
      <div id="walletAddress" class="mt-2 text-sm text-red-600">🔴 未连接钱包</div>
    </div>

    <!-- Form -->
    <div class="space-y-4">
      <input type="text" id="name" placeholder="Token Name" class="w-full px-4 py-2 rounded border border-gray-300">
      <input type="text" id="symbol" placeholder="Symbol (e.g. BMEME)" class="w-full px-4 py-2 rounded border border-gray-300">
      <input type="number" id="decimals" placeholder="Decimals (e.g. 6)" class="w-full px-4 py-2 rounded border border-gray-300" value="6">
      <input type="text" id="supply" placeholder="Total Supply (e.g. 1000000000000000)" class="w-full px-4 py-2 rounded border border-gray-300">
      <input type="text" id="buyAmount" placeholder="Initial Buy Amount" class="w-full px-4 py-2 rounded border border-gray-300">
    </div>

    <button onclick="createToken()" class="mt-6 w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed font-semibold" disabled>
      Mint Token
    </button>

    <div id="result" class="mt-4 text-sm text-center"></div>
  </div>

  <script>
    async function createToken() {
      // 检查钱包连接状态
      if (!window.wallet || !window.wallet.publicKey) {
        document.getElementById("result").innerHTML = "❌ 请先连接钱包";
        return;
      }

      const name = document.getElementById("name").value;
      const symbol = document.getElementById("symbol").value;
      const decimals = parseInt(document.getElementById("decimals").value);
      const supply = document.getElementById("supply").value;
      const buyAmount = document.getElementById("buyAmount").value;

      // 表单验证
      if (!name || !symbol || !supply) {
        document.getElementById("result").innerHTML = "❌ 请填写所有必填字段";
        return;
      }

      const resultEl = document.getElementById("result");
      resultEl.innerText = "⏳ Minting in progress...";

      const payload = {
        name,
        symbol,
        decimals,
        supply,
        buyAmount,
        createOnly: false,
        migrateType: "amm"
      };

      try {
        const res = await fetch("https://launch.letsbonk.fun/launchpad/createMint", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok) {
          resultEl.innerHTML = `✅ Token created!<br><pre class="text-left text-xs mt-2 bg-gray-100 p-2 rounded overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          resultEl.innerHTML = `❌ Error:<br><pre class="text-left text-xs mt-2 bg-red-100 p-2 rounded overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (err) {
        resultEl.innerHTML = `❌ Exception:<br><pre class="text-left text-xs mt-2 bg-red-100 p-2 rounded overflow-auto">${err.message}</pre>`;
      }
    }

    // 更新调试状态显示
    function updateDebugStatus() {
      const debugStatus = document.getElementById('debugStatus');
      const walletStatus = document.getElementById('walletStatus');
      
      if (debugStatus) {
        debugStatus.textContent = '开启';
      }
      
      if (walletStatus) {
        const phantom = isPhantomInstalled();
        walletStatus.textContent = phantom ? '已安装 Phantom' : '未安装 Phantom';
      }
    }

    // 页面加载后更新调试状态
    setTimeout(updateDebugStatus, 1000);
  </script>
</body>
</html>
