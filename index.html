<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Meme Token Launcher - LetsBonk + Phantom</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import {
      PhantomWalletAdapter
    } from "https://unpkg.com/@solana/wallet-adapter-wallets@0.20.0/lib/index.browser.mjs";

    let walletAdapter = null;
    let isConnected = false;

    // æ£€æŸ¥ Phantom é’±åŒ…æ˜¯å¦å®‰è£…
    function isPhantomInstalled() {
      return typeof window.solana !== 'undefined' && window.solana.isPhantom;
    }

    // æ›´æ–°é’±åŒ…UIçŠ¶æ€
    function updateWalletUI() {
      const connectBtn = document.getElementById("connectBtn");
      const walletAddress = document.getElementById("walletAddress");
      const mintBtn = document.querySelector("button[onclick='createToken()']");

      if (isConnected && walletAdapter && walletAdapter.publicKey) {
        const address = walletAdapter.publicKey.toBase58();
        const shortAddress = `${address.slice(0, 4)}...${address.slice(-4)}`;
        
        connectBtn.innerHTML = "ğŸ”— æ–­å¼€é’±åŒ…";
        connectBtn.className = "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700";
        connectBtn.onclick = disconnectWallet;
        
        walletAddress.innerHTML = `ğŸŸ¢ å·²è¿æ¥: <span class="font-mono">${shortAddress}</span>`;
        walletAddress.className = "mt-2 text-sm text-green-600 font-medium";
        
        mintBtn.disabled = false;
        mintBtn.className = "mt-6 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 font-semibold";
      } else {
        connectBtn.innerHTML = "ğŸ”Œ è¿æ¥ Phantom";
        connectBtn.className = "bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700";
        connectBtn.onclick = connectWallet;
        
        walletAddress.innerHTML = "ğŸ”´ æœªè¿æ¥é’±åŒ…";
        walletAddress.className = "mt-2 text-sm text-red-600";
        
        mintBtn.disabled = true;
        mintBtn.className = "mt-6 w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed font-semibold";
      }
    }

    // è¿æ¥é’±åŒ…
    async function connectWallet() {
      const connectBtn = document.getElementById("connectBtn");
      const walletAddress = document.getElementById("walletAddress");

      try {
        // æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Phantom
        if (!isPhantomInstalled()) {
          walletAddress.innerHTML = "âŒ è¯·å…ˆå®‰è£… <a href='https://phantom.app/' target='_blank' class='text-blue-600 underline'>Phantom é’±åŒ…</a>";
          walletAddress.className = "mt-2 text-sm text-red-600";
          return;
        }

        // æ˜¾ç¤ºè¿æ¥ä¸­çŠ¶æ€
        connectBtn.innerHTML = "â³ è¿æ¥ä¸­...";
        connectBtn.disabled = true;
        walletAddress.innerHTML = "ğŸ”„ æ­£åœ¨è¿æ¥é’±åŒ…...";
        walletAddress.className = "mt-2 text-sm text-yellow-600";

        // åˆå§‹åŒ–é’±åŒ…é€‚é…å™¨
        if (!walletAdapter) {
          walletAdapter = new PhantomWalletAdapter();
        }

        // è¿æ¥é’±åŒ…
        await walletAdapter.connect();
        
        isConnected = true;
        window.wallet = walletAdapter;
        
        // ç›‘å¬é’±åŒ…æ–­å¼€äº‹ä»¶
        walletAdapter.on('disconnect', () => {
          isConnected = false;
          window.wallet = null;
          updateWalletUI();
        });

        updateWalletUI();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showNotification("é’±åŒ…è¿æ¥æˆåŠŸï¼", "success");

      } catch (error) {
        console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error);
        isConnected = false;
        
        let errorMessage = "è¿æ¥å¤±è´¥";
        if (error.message.includes('User rejected')) {
          errorMessage = "ç”¨æˆ·å–æ¶ˆè¿æ¥";
        } else if (error.message.includes('wallet not found')) {
          errorMessage = "æœªæ‰¾åˆ°é’±åŒ…";
        }
        
        walletAddress.innerHTML = `âŒ ${errorMessage}`;
        walletAddress.className = "mt-2 text-sm text-red-600";
        
        updateWalletUI();
        showNotification(errorMessage, "error");
      } finally {
        connectBtn.disabled = false;
      }
    }

    // æ–­å¼€é’±åŒ…
    async function disconnectWallet() {
      try {
        if (walletAdapter && isConnected) {
          await walletAdapter.disconnect();
        }
        isConnected = false;
        window.wallet = null;
        updateWalletUI();
        showNotification("é’±åŒ…å·²æ–­å¼€", "info");
      } catch (error) {
        console.error('æ–­å¼€é’±åŒ…å¤±è´¥:', error);
        showNotification("æ–­å¼€é’±åŒ…å¤±è´¥", "error");
      }
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = "info") {
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : 
                     type === 'error' ? 'bg-red-500' : 
                     type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
      
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);
      
      // 3ç§’åç§»é™¤
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // é¡µé¢åŠ è½½æ—¶å°è¯•è‡ªåŠ¨é‡è¿
    window.addEventListener('load', async () => {
      updateWalletUI();
      
      // å¦‚æœä¹‹å‰å·²è¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥
      if (isPhantomInstalled() && window.solana.isConnected) {
        try {
          walletAdapter = new PhantomWalletAdapter();
          await walletAdapter.connect();
          isConnected = true;
          window.wallet = walletAdapter;
          updateWalletUI();
          showNotification("é’±åŒ…è‡ªåŠ¨é‡è¿æˆåŠŸ", "success");
        } catch (error) {
          console.log('è‡ªåŠ¨é‡è¿å¤±è´¥:', error);
        }
      }
    });

    // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.connectWallet = connectWallet;
    window.disconnectWallet = disconnectWallet;
    window.updateWalletUI = updateWalletUI;
  </script>
</head>
<body class="bg-gradient-to-r from-purple-100 via-yellow-100 to-blue-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">ğŸš€ Launch Meme Token</h1>

    <!-- Wallet -->
    <div class="mb-6 text-center">
      <button id="connectBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
        ğŸ”Œ è¿æ¥ Phantom
      </button>
      <div id="walletAddress" class="mt-2 text-sm text-red-600">ğŸ”´ æœªè¿æ¥é’±åŒ…</div>
    </div>

    <!-- Form -->
    <div class="space-y-4">
      <input type="text" id="name" placeholder="Token Name" class="w-full px-4 py-2 rounded border border-gray-300">
      <input type="text" id="symbol" placeholder="Symbol (e.g. BMEME)" class="w-full px-4 py-2 rounded border border-gray-300">
      <input type="number" id="decimals" placeholder="Decimals (e.g. 6)" class="w-full px-4 py-2 rounded border border-gray-300" value="6">
      <input type="text" id="supply" placeholder="Total Supply (e.g. 1000000000000000)" class="w-full px-4 py-2 rounded border border-gray-300">
      <input type="text" id="buyAmount" placeholder="Initial Buy Amount" class="w-full px-4 py-2 rounded border border-gray-300">
    </div>

    <button onclick="createToken()" class="mt-6 w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed font-semibold" disabled>
      Mint Token
    </button>

    <div id="result" class="mt-4 text-sm text-center"></div>
  </div>

  <script>
    async function createToken() {
      // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
      if (!window.wallet || !window.wallet.publicKey) {
        document.getElementById("result").innerHTML = "âŒ è¯·å…ˆè¿æ¥é’±åŒ…";
        return;
      }

      const name = document.getElementById("name").value;
      const symbol = document.getElementById("symbol").value;
      const decimals = parseInt(document.getElementById("decimals").value);
      const supply = document.getElementById("supply").value;
      const buyAmount = document.getElementById("buyAmount").value;

      // è¡¨å•éªŒè¯
      if (!name || !symbol || !supply) {
        document.getElementById("result").innerHTML = "âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ";
        return;
      }

      const resultEl = document.getElementById("result");
      resultEl.innerText = "â³ Minting in progress...";

      const payload = {
        name,
        symbol,
        decimals,
        supply,
        buyAmount,
        createOnly: false,
        migrateType: "amm"
      };

      try {
        const res = await fetch("https://launch.letsbonk.fun/launchpad/createMint", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok) {
          resultEl.innerHTML = `âœ… Token created!<br><pre class="text-left text-xs mt-2 bg-gray-100 p-2 rounded overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          resultEl.innerHTML = `âŒ Error:<br><pre class="text-left text-xs mt-2 bg-red-100 p-2 rounded overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (err) {
        resultEl.innerHTML = `âŒ Exception:<br><pre class="text-left text-xs mt-2 bg-red-100 p-2 rounded overflow-auto">${err.message}</pre>`;
      }
    }
  </script>
</body>
</html>
